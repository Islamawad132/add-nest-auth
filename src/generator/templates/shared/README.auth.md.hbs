# Authentication Module

Generated by **add-nest-auth** on {{timestamp}}

## Overview

This authentication module provides:
- ‚úÖ JWT-based authentication
{{#if rbac.enabled}}
- ‚úÖ Role-Based Access Control (RBAC)
{{/if}}
{{#if features.refreshTokens}}
- ‚úÖ Refresh token rotation
{{/if}}
- ‚úÖ Password hashing with bcrypt
- ‚úÖ Request validation with class-validator
{{#if (eq orm "typeorm")}}
- ‚úÖ TypeORM integration
{{/if}}

## Endpoints

### Public Endpoints (No authentication required)

#### POST /auth/register
Register a new user.

**Request body:**
```json
{
  "email": "user@example.com",
  "password": "your-password"
}
```

**Response:**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
{{#if features.refreshTokens}}
  "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
{{/if}}
  "user": {
    "id": "uuid",
    "email": "user@example.com"{{#if rbac.enabled}},
    "roles": ["User"]{{/if}}
  }
}
```

#### POST /auth/login
Login with existing credentials.

**Request body:**
```json
{
  "email": "user@example.com",
  "password": "your-password"
}
```

**Response:** Same as register

{{#if features.refreshTokens}}
#### POST /auth/refresh
Refresh access token using refresh token.

**Request body:**
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIs..."
}
```

**Response:**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs..."
}
```
{{/if}}

### Protected Endpoints (Authentication required)

#### GET /users/profile
Get current user profile.

**Headers:**
```
Authorization: Bearer <accessToken>
```

**Response:**
```json
{
  "id": "uuid",
  "email": "user@example.com"{{#if rbac.enabled}},
  "roles": ["User"]{{/if}}
}
```

{{#if rbac.enabled}}
#### GET /users (Admin only)
Get all users.

**Headers:**
```
Authorization: Bearer <accessToken>
```

**Response:**
```json
[
  {
    "id": "uuid",
    "email": "user@example.com",
    "roles": ["User"],
    "createdAt": "2026-01-01T00:00:00.000Z"
  }
]
```
{{/if}}

## Setup

### Enable Global JWT Guard (Recommended)

To automatically protect all routes by default, add the JWT guard globally in your `main.ts`.

**üìÑ See `main.ts.example` in your project root for a complete setup example.**

Quick setup - add these lines to your `main.ts`:

```typescript
import { Reflector } from '@nestjs/core';
import { JwtAuthGuard } from './auth/guards/jwt-auth.guard';

// In bootstrap() function:
const reflector = app.get(Reflector);
app.useGlobalGuards(new JwtAuthGuard(reflector));
```

This makes all routes protected by default. Use `@Public()` to make specific routes public.

**Alternative:** Manually add `@UseGuards(JwtAuthGuard)` to each protected controller/route.

## Usage

### Protect Routes

By default (with global guard), all routes require authentication. Use the `@Public()` decorator to make routes public:

```typescript
import { Public } from './auth/decorators/public.decorator';

@Public()
@Get('public')
getPublicData() {
  return 'This endpoint is public';
}
```

### Get Current User

Use the `@CurrentUser()` decorator to access the authenticated user:

```typescript
import { CurrentUser } from './auth/decorators/current-user.decorator';

@Get('me')
getMe(@CurrentUser() user: any) {
  return user;
}
```

{{#if rbac.enabled}}
### Role-Based Access Control

Use the `@Roles()` decorator to restrict access by role:

```typescript
import { Roles } from './auth/decorators/roles.decorator';
import { RolesGuard } from './auth/guards/roles.guard';

@UseGuards(JwtAuthGuard, RolesGuard)
@Roles('Admin')
@Get('admin-only')
adminOnlyRoute() {
  return 'Only admins can see this';
}
```

Available roles: {{#each rbac.roles}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}
{{/if}}

## Environment Variables

Copy `.env.example` to `.env` and update the values:

```bash
cp .env.example .env
```

Required variables:
- `JWT_SECRET` - Secret key for JWT signing (auto-generated, but you can change it)
- `JWT_EXPIRES_IN` - Access token expiration (e.g., "1h", "15m")
{{#if features.refreshTokens}}
- `JWT_REFRESH_EXPIRES_IN` - Refresh token expiration (e.g., "7d")
{{/if}}
{{#if (eq orm "typeorm")}}
- `DATABASE_*` - Database connection details
{{/if}}

{{#if (eq orm "typeorm")}}
## Database Setup

### Create Migration

Generate a migration for the auth tables:

```bash
npm run migration:generate -- src/migrations/CreateAuthTables
```

### Run Migration

Apply the migration:

```bash
npm run migration:run
```

### Revert Migration

Rollback the migration:

```bash
npm run migration:revert
```
{{/if}}

## Security Best Practices

1. **Never commit .env file** - It contains sensitive secrets
2. **Use strong JWT secrets** - At least 32 characters, random
3. **HTTPS in production** - Always use HTTPS to protect tokens
4. **Short token expiration** - Keep access tokens short-lived
{{#if features.refreshTokens}}
5. **Rotate refresh tokens** - Refresh tokens are automatically rotated
{{/if}}
6. **Rate limiting** - Add rate limiting to auth endpoints
7. **Password requirements** - Enforce strong password policies

## Testing

### Register a User

```bash
curl -X POST http://localhost:3000/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Password123!"}'
```

### Login

```bash
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Password123!"}'
```

### Access Protected Route

```bash
curl http://localhost:3000/users/profile \
  -H "Authorization: Bearer <your-access-token>"
```

## Troubleshooting

### "JWT secret not found"
Make sure `.env` file exists and contains `JWT_SECRET`.

### "Database connection failed"
Check your database is running and credentials in `.env` are correct.

### "Invalid credentials"
Ensure email and password are correct. Passwords are case-sensitive.

{{#if (eq orm "typeorm")}}
### "Entity not found"
Run migrations: `npm run migration:run`
{{/if}}

## Documentation

- [NestJS Authentication](https://docs.nestjs.com/security/authentication)
- [Passport.js](http://www.passportjs.org/)
- [JWT](https://jwt.io/)
{{#if (eq orm "typeorm")}}
- [TypeORM](https://typeorm.io/)
{{/if}}

---

Generated with ‚ù§Ô∏è by [add-nest-auth](https://github.com/Islamawad132/add-nest-auth)
